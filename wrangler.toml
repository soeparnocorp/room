name = "room"
compatibility_date = "2024-01-01"
main = "src/chat.mjs"

# ============ BINDINGS ============

# KV Namespace binding
kv_namespaces = [
  { binding = "READTALK_KV", id = "13a468e30cc84fe58ff6297d799050f2" }
]

# D1 Database binding
[[d1_databases]]
binding = "READTALK_DB"
database_name = "readtalk_db"
database_id = "ff653b9c-4e2c-479d-8aa4-497da62de3c5"

# R2 Bucket binding
[[r2_buckets]]
binding = "READTALK_R2"
bucket_name = "readtalk-r2"

# ============ DURABLE OBJECTS ============
[durable_objects]
bindings = [
  { name = "users", class_name = "UserConnection" },      # BARU: 1 user = 1 DO
  { name = "rooms", class_name = "ChatRoom" },            # SUDAH ADA: 1 room = 1 DO
  { name = "limiters", class_name = "RateLimiter" }       # SUDAH ADA: rate limiter per IP
]

# ============ MIGRATIONS ============
# Migration untuk class baru (UserConnection)
[[migrations]]
tag = "v2"
new_classes = ["UserConnection"]

# Migration sebelumnya (tetap ada)
[[migrations]]
tag = "v1"
new_classes = ["ChatRoom", "RateLimiter"]

# ============ RULES ============
[[rules]]
type = "Data"
globs = ["**/*.html"]
fallthrough = false

# ============ OBSERVABILITY ============
[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1

# ============ DEVELOPMENT ============
[dev]
ip = "localhost"
port = 8787
local_protocol = "http"

# ============ BUILD ============
[build]
upload.format = "modules"  # Karena pake import/export (ES modules)
