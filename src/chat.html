<!DOCTYPE html>
<!--
  THIS IS NOT THE INTERESTING FILE

  This is just some UI code. There's nothing interesting and unique in this file. The interesting
  thing about this demo is the server side, which is in chat.mjs.

  WARNING: This was written by a systems engineer, not a web developer. It's probably bad.
-->

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<!--===================================================================================-->
<!-- Inline style to avoid an extra round trip before the page can render. -->
<style type="text/css">
* {
  box-sizing: border-box;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f0f2f5;
  color: #111b21;
}

/* ===== LAYER SYSTEM ===== */
.app-layer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
  overflow: hidden;
}

/* Layer Sidebar (Conversation List/Rak Buku) */
#layer-sidebar {
  z-index: 10;
  background: #ffffff;
  display: flex;
  flex-direction: column;
}

/* Layer Chat (Canvas) */
#layer-chat {
  z-index: 20;
  background-color: #efeae2;
  background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23000000' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
}

/* Layer switching */
.layer-hidden {
  transform: translateX(100%);
}

/* Desktop: Show both layers side-by-side */
@media(min-width:901px) {
  .app-layer {
    position: fixed;
    width: 300px; /* Sidebar width */
    transform: none !important;
  }
  
  #layer-sidebar {
    left: 0;
    border-right: 1px solid #e0e0e0;
  }
  
  #layer-chat {
    left: 300px;
    width: calc(100% - 300px);
  }
}

/* ===== SIDEBAR STYLES (Layer 1) ===== */
.sidebar-header {
  padding: 20px 16px 15px;
  border-bottom: 1px solid #e0e0e0;
  background: #f8f9fa;
}

.sidebar-header h2 {
  margin: 0 0 5px 0;
  color: #111b21;
  font-size: 18px;
}

.sidebar-header .subtitle {
  color: #667781;
  font-size: 13px;
  margin: 0;
}

/* Rak Buku Container */
#roster {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}

/* Sidebar Section Styles */
.sidebar-section {
  margin: 0;
  border-bottom: 1px solid #e0e0e0;
  padding: 16px;
}

.section-header {
  font-size: 12px;
  font-weight: 600;
  color: #667781;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
  display: block;
}

/* Clickable Items (Buku di Rak) */
.clickable-item {
  padding: 12px 14px;
  background: #ffffff;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: block;
  width: 100%;
  text-align: left;
  margin-bottom: 8px;
}

.clickable-item:hover:not(.inactive) {
  background: #f5f5f5;
  border-color: #cccccc;
}

.clickable-item.active {
  background: #ff0000;
  color: white;
  border-color: #ff0000;
}

.clickable-item.inactive {
  color: #999999;
  cursor: default;
  font-style: italic;
  opacity: 0.7;
}

/* Participants list styling */
#participants-list p {
  padding: 10px 14px;
  margin: 6px 0;
  border-radius: 6px;
  cursor: default;
  font-weight: 500;
  background-color: #f8f9fa;
  border-left: 3px solid #ff0000;
}

#participants-list p:hover {
  background-color: #f0f0f0;
}

/* ===== CHAT STYLES (Layer 2) ===== */
/* Chat Header dengan Tombol Kembali */
.chat-header {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: #ff0000;
  color: white;
  display: flex;
  align-items: center;
  padding: 0 16px;
  z-index: 30;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.back-button {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  padding: 8px;
  margin-right: 12px;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.back-button:hover {
  background: rgba(255,255,255,0.1);
}

#current-room-title {
  font-weight: 600;
  font-size: 17px;
  flex: 1;
}

/* Chat log area */
#chatlog {
  position: absolute;
  top: 60px; /* Di bawah header */
  bottom: 60px; /* Di atas input */
  left: 0;
  right: 0;
  overflow-y: auto;
  padding: 20px;
  overflow-wrap: break-word;
}

#chatlog span.username {
  font-weight: 600;
  color: #111b21;
}
#spacer {
  height: calc(100vh - 60px - 5em);
}

/* Message bubbles */
#chatlog p {
  max-width: 65%;
  margin: 8px 0;
  padding: 8px 12px;
  border-radius: 7.5px;
  position: relative;
  word-wrap: break-word;
  line-height: 1.4;
}

/* Sent messages (from current user) */
#chatlog p:has(> .username) {
  background-color: #ff0000;
  color: white;
  margin-left: auto;
  margin-right: 0;
  border-top-right-radius: 0;
}

/* Received messages */
#chatlog p:not(:has(> .username)) {
  background-color: #ffffff;
  color: #111b21;
  margin-right: auto;
  margin-left: 0;
  border-top-left-radius: 0;
  box-shadow: 0 1px 0.5px rgba(0,0,0,0.05);
}

/* System messages */
#chatlog p:not(:has(> .username)):not(:has(> span)) {
  background-color: transparent;
  color: #667781;
  text-align: center;
  font-style: italic;
  max-width: 100%;
  font-size: 14px;
}

/* Chat input */
#chat-input {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 60px;
  border: none;
  padding: 0 20px 0 70px;
  outline: none;
  font-size: 16px;
  background-color: #f0f2f5;
  border-top: 1px solid #e0e0e0;
  color: #111b21;
}

#chatroom::before {
  z-index: 1;
  display: block;
  content: ">";
  position: absolute;
  bottom: 0;
  left: 0;
  width: 70px;
  height: 60px;
  line-height: 60px;
  text-align: center;
  font-weight: bold;
  font-size: 20px;
  color: #667781;
  -webkit-text-stroke-width: 1px;
  background-color: #f0f2f5;
  border-top: 1px solid #e0e0e0;
}

/* Desktop input fix */
@media(min-width:901px) {
  #chat-input {
    left: 0;
    width: 100%;
    padding-left: 90px;
  }
  #chatroom::before {
    left: 0;
  }
}

/* ===== FORM STYLES (Original Forms) ===== */
#name-form {
  position: fixed;
  z-index: 100;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #f0f2f5;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#name-input {
  font-size: 24px;
  padding: 16px 20px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  width: 400px;
  max-width: 90%;
  margin-bottom: 20px;
  background-color: #ffffff;
  color: #111b21;
  text-align: center;
  transition: border-color 0.2s;
}

#name-input:focus {
  border-color: #ff0000;
  outline: none;
}

#name-form p {
  text-align: center;
  color: #667781;
  max-width: 600px;
  line-height: 1.6;
  font-size: 16px;
}

#name-form a {
  color: #ff0000;
  text-decoration: none;
  font-weight: 600;
}

#name-form a:hover {
  text-decoration: underline;
}

#room-form {
  position: fixed;
  z-index: 90;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #f0f2f5;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}

#room-form p {
  color: #111b21;
  margin: 10px 0;
  font-weight: 500;
}

#room-name {
  font-size: inherit;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  height: 60px;
  width: 400px;
  max-width: 90%;
  padding: 0 20px;
  margin-bottom: 20px;
  background-color: #ffffff;
  color: #111b21;
  transition: border-color 0.2s;
}

#room-name:focus {
  border-color: #ff0000;
  outline: none;
}

#room-form button {
  font-size: 20px;
  padding: 16px 32px;
  margin: 10px;
  border: none;
  border-radius: 24px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 600;
}

#go-public {
  background-color: #ff0000;
  color: white;
  width: 180px;
}

#go-public:hover {
  background-color: #e60000;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 0, 0, 0.2);
}

#go-private {
  background-color: #ffffff;
  color: #ff0000;
  border: 2px solid #ff0000 !important;
  width: 280px;
}

#go-private:hover {
  background-color: #fff5f5;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 0, 0, 0.1);
}

#room-form button:active {
  transform: translateY(0);
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: #cccccc;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: #b3b3b3;
}

/* Responsive adjustments */
@media(max-width:660px) {
  #name-input, #room-form { font-size: 20px; }
  #name-form p { font-size: 14px; }
  #room-name {
    height: 50px;
    width: 300px;
  }
  #room-form button {
    font-size: 18px;
    padding: 14px 24px;
  }
  #go-public { width: 150px; }
  #go-private { width: 240px; }
  
  .sidebar-section {
    padding: 14px;
  }
  
  .clickable-item {
    padding: 10px 12px;
  }
}

@media(max-width:500px) {
  #name-input, #room-form { font-size: 18px; }
  #name-form p { font-size: 13px; }
  #room-name {
    height: 48px;
    width: 280px;
  }
  #room-form button {
    font-size: 16px;
    padding: 12px 20px;
  }
  #go-public { width: 130px; }
  #go-private { width: 220px; }
  
  .sidebar-header {
    padding: 16px 14px 12px;
  }
}

/* Selection color */
::selection {
  background-color: rgba(255, 0, 0, 0.2);
}
</style>

<!--===================================================================================-->
<!-- The actual HTML. There is not much of it. -->

  </head>
  <body>
    <!-- Form 1: Your Name -->
    <form id="name-form" action="/fake-form-action">
      <input id="name-input" placeholder="your name">
      <p>This chat runs entirely on the edge<br>
        <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">Durable Objects</a></p>
    </form>
    
    <!-- Form 2: Room Selection -->
    <form id="room-form" action="/fake-form-action">
      <p>Public Room:</p>
      <input id="room-name" placeholder="room name"><button id="go-public">Go &raquo;</button>
      <p>OR</p>
      <button id="go-private">Private Room &raquo;</button>
    </form>
    
    <!-- LAYER 1: Sidebar (Rak Buku) -->
    <div id="layer-sidebar" class="app-layer layer-hidden">
      <div class="sidebar-header">
        <h2>Chat Rooms</h2>
        <p class="subtitle">Select a room to start chatting</p>
      </div>
      
      <!-- Rak Buku Container -->
      <div id="roster">
        <!-- Section 1: Your Name -->
        <div class="sidebar-section">
          <div class="section-header">Your Name</div>
          <div id="your-name-display" class="section-content">
            <div id="current-username" class="clickable-item inactive">(not set)</div>
          </div>
        </div>
        
        <!-- Section 2: Public Room (Buku 1) -->
        <div class="sidebar-section">
          <div class="section-header">Public Room</div>
          <div id="public-room-display" class="section-content">
            <div id="current-public-room" class="clickable-item inactive">(not set)</div>
          </div>
        </div>
        
        <!-- Section 3: Private Room (Buku 2) -->
        <div class="sidebar-section">
          <div class="section-header">Private Room</div>
          <div id="private-room-display" class="section-content">
            <div id="current-private-room" class="clickable-item inactive">(not set)</div>
          </div>
        </div>
        
        <!-- Dynamic Participants Section -->
        <div id="participants-container"></div>
      </div>
    </div>
    
    <!-- LAYER 2: Chat (Canvas) -->
    <div id="layer-chat" class="app-layer layer-hidden">
      <!-- Header dengan Tombol Kembali -->
      <div class="chat-header">
        <button id="back-to-sidebar" class="back-button">‚Üê</button>
        <div id="current-room-title">Chat Room</div>
      </div>
      
      <!-- Chat log -->
      <div id="chatlog">
        <div id="spacer"></div>
      </div>
      
      <!-- Chat input -->
      <form id="chatroom" action="/fake-form-action">
        <input id="chat-input" placeholder="Type a message...">
      </form>
    </div>
  </body>

<!--===================================================================================-->
<!-- Client-side JavaScript code for the app. -->

<script type="text/javascript">
// ===== GLOBAL VARIABLES =====
let currentWebSocket = null;
let currentLayer = 'form'; // 'form', 'sidebar', or 'chat'

let nameForm = document.querySelector("#name-form");
let nameInput = document.querySelector("#name-input");
let roomForm = document.querySelector("#room-form");
let roomNameInput = document.querySelector("#room-name");
let goPublicButton = document.querySelector("#go-public");
let goPrivateButton = document.querySelector("#go-private");
let chatroom = document.querySelector("#chatroom");
let chatlog = document.querySelector("#chatlog");
let chatInput = document.querySelector("#chat-input");
let backToSidebarBtn = document.querySelector("#back-to-sidebar");
let currentRoomTitle = document.querySelector("#current-room-title");

let username;
let roomname;

let hostname = window.location.host;
if (hostname == "") {
  // Probably testing the HTML locally.
  hostname = "room.soeparnocorp.workers.dev";
}

// Is the chatlog scrolled to the bottom?
let isAtBottom = true;

// ===== LAYER MANAGEMENT =====
function switchLayer(targetLayer) {
  const sidebarLayer = document.getElementById('layer-sidebar');
  const chatLayer = document.getElementById('layer-chat');
  
  // Hide all layers first
  sidebarLayer.classList.add('layer-hidden');
  chatLayer.classList.add('layer-hidden');
  nameForm.style.display = 'none';
  roomForm.style.display = 'none';
  
  // Show target layer
  if (targetLayer === 'form-name') {
    nameForm.style.display = 'flex';
    currentLayer = 'form';
  } else if (targetLayer === 'form-room') {
    roomForm.style.display = 'flex';
    currentLayer = 'form';
  } else if (targetLayer === 'sidebar') {
    sidebarLayer.classList.remove('layer-hidden');
    currentLayer = 'sidebar';
    setupClickableItems(); // Pastikan items bisa diklik
  } else if (targetLayer === 'chat') {
    chatLayer.classList.remove('layer-hidden');
    currentLayer = 'chat';
    setTimeout(() => { chatInput.focus(); }, 100);
  }
}

// ===== SIDEBAR ITEMS MANAGEMENT =====
function updateYourNameDisplay(name) {
  const display = document.getElementById('current-username');
  if (name && name.length > 0) {
    display.textContent = name;
    display.classList.remove('inactive');
    display.classList.add('active');
  } else {
    display.textContent = '(not set)';
    display.classList.add('inactive');
    display.classList.remove('active');
  }
}

function updatePublicRoomDisplay(roomName) {
  const display = document.getElementById('current-public-room');
  if (roomName && roomName.length > 0) {
    display.textContent = roomName;
    display.classList.remove('inactive');
    display.classList.add('active');
  } else {
    display.textContent = '(not set)';
    display.classList.add('inactive');
    display.classList.remove('active');
  }
}

function updatePrivateRoomDisplay(roomSlug) {
  const display = document.getElementById('current-private-room');
  if (roomSlug && roomSlug.length > 0) {
    const displayName = roomSlug.length > 10 ? roomSlug.substring(0, 8) + '...' : roomSlug;
    display.textContent = displayName;
    display.title = "Private Room: " + roomSlug;
    display.classList.remove('inactive');
    display.classList.add('active');
  } else {
    display.textContent = '(not set)';
    display.classList.add('inactive');
    display.classList.remove('active');
  }
}

function setupClickableItems() {
  // Setup click handler for Public Room
  const publicRoomItem = document.getElementById('current-public-room');
  if (publicRoomItem && !publicRoomItem.classList.contains('inactive')) {
    publicRoomItem.onclick = function() {
      const roomName = this.textContent;
      if (roomName && roomName !== '(not set)') {
        currentRoomTitle.textContent = `#${roomName}`;
        switchLayer('chat');
        
        // Jika room berbeda, switch room
        if (roomname !== roomName) {
          switchToRoom(roomName, false);
        }
      }
    };
  }
  
  // Setup click handler for Private Room
  const privateRoomItem = document.getElementById('current-private-room');
  if (privateRoomItem && !privateRoomItem.classList.contains('inactive')) {
    privateRoomItem.onclick = function() {
      const roomSlug = this.title.replace('Private Room: ', '');
      if (roomSlug && roomSlug !== 'Private Room: ') {
        const displayName = roomSlug.length > 10 ? roomSlug.substring(0, 8) + '...' : roomSlug;
        currentRoomTitle.textContent = `üîí ${displayName}`;
        switchLayer('chat');
        
        // Jika room berbeda, switch room
        if (roomname !== roomSlug) {
          switchToRoom(roomSlug, true);
        }
      }
    };
  }
}

// ===== ROOM SWITCHING =====
function switchToRoom(targetRoomName, isPrivate = false) {
  // Close existing connection
  if (currentWebSocket) {
    currentWebSocket.close();
    currentWebSocket = null;
  }
  
  // Update global roomname
  roomname = targetRoomName;
  document.location.hash = '#' + targetRoomName;
  
  // Update UI display
  if (isPrivate) {
    updatePrivateRoomDisplay(targetRoomName);
    updatePublicRoomDisplay('');
  } else {
    updatePublicRoomDisplay(targetRoomName);
    updatePrivateRoomDisplay('');
  }
  
  // Clear participant list when switching rooms
  const participantsContainer = document.getElementById('participants-container');
  participantsContainer.innerHTML = '';
  
  // Update room title in chat header
  const displayName = isPrivate 
    ? (targetRoomName.length > 10 ? targetRoomName.substring(0, 8) + '...' : targetRoomName)
    : targetRoomName;
  currentRoomTitle.textContent = isPrivate ? `üîí ${displayName}` : `#${displayName}`;
  
  // Join new room
  join();
}

// ===== PARTICIPANT LIST MANAGEMENT =====
function updateParticipantList() {
  const participantsContainer = document.getElementById('participants-container');
  const roster = document.getElementById('roster');
  const originalParticipants = roster.querySelectorAll('p');
  
  if (originalParticipants.length > 0) {
    // Create participants section if it doesn't exist
    if (!participantsContainer.querySelector('.sidebar-section')) {
      const participantSection = document.createElement('div');
      participantSection.className = 'sidebar-section';
      participantSection.innerHTML = `
        <div class="section-header">Participants (${originalParticipants.length})</div>
        <div class="section-content">
          <div id="participants-list"></div>
        </div>
      `;
      participantsContainer.appendChild(participantSection);
    }
    
    // Update participants list
    const participantsList = document.getElementById('participants-list');
    if (participantsList) {
      participantsList.innerHTML = '';
      
      originalParticipants.forEach(p => {
        const participantItem = p.cloneNode(true);
        participantItem.style.cursor = 'default';
        participantsList.appendChild(participantItem);
      });
      
      // Update participant count
      const header = participantsContainer.querySelector('.section-header');
      if (header) {
        header.textContent = `Participants (${originalParticipants.length})`;
      }
    }
    
    // Remove original <p> elements from roster
    originalParticipants.forEach(p => p.remove());
  } else {
    // Remove participants section if no participants
    participantsContainer.innerHTML = '';
  }
}

// ===== ORIGINAL FORM FLOW (MODIFIED) =====
function startNameChooser() {
  switchLayer('form-name');
  
  nameForm.addEventListener("submit", event => {
    event.preventDefault();
    username = nameInput.value;
    if (username.length > 0) {
      updateYourNameDisplay(username);
      startRoomChooser();
    }
  });

  nameInput.addEventListener("input", event => {
    const currentName = event.currentTarget.value;
    if (currentName.length > 0) {
      updateYourNameDisplay(currentName);
    } else {
      updateYourNameDisplay('');
    }
    
    if (currentName.length > 32) {
      event.currentTarget.value = currentName.slice(0, 32);
    }
  });

  nameInput.focus();
}

function startRoomChooser() {
  switchLayer('form-room');

  if (document.location.hash.length > 1) {
    roomname = document.location.hash.slice(1);
    const isPrivate = roomname.match(/^[0-9a-f]{64}$/);
    if (isPrivate) {
      updatePrivateRoomDisplay(roomname);
    } else {
      updatePublicRoomDisplay(roomname);
    }
    completeRoomSelection();
    return;
  }

  roomForm.addEventListener("submit", event => {
    event.preventDefault();
    roomname = roomNameInput.value;
    if (roomname.length > 0) {
      updatePublicRoomDisplay(roomname);
      completeRoomSelection();
    }
  });

  roomNameInput.addEventListener("input", event => {
    if (event.currentTarget.value.length > 32) {
      event.currentTarget.value = event.currentTarget.value.slice(0, 32);
    }
  });

  goPublicButton.addEventListener("click", event => {
    roomname = roomNameInput.value;
    if (roomname.length > 0) {
      updatePublicRoomDisplay(roomname);
      completeRoomSelection();
    }
  });

  goPrivateButton.addEventListener("click", async event => {
    roomNameInput.disabled = true;
    goPublicButton.disabled = true;
    event.currentTarget.disabled = true;

    let response = await fetch("https://" + hostname + "/api/room", {method: "POST"});
    if (!response.ok) {
      alert("something went wrong");
      document.location.reload();
      return;
    }

    roomname = await response.text();
    updatePrivateRoomDisplay(roomname);
    completeRoomSelection();
  });

  roomNameInput.focus();
}

function completeRoomSelection() {
  // Set room title
  const isPrivate = roomname.match(/^[0-9a-f]{64}$/);
  const displayName = isPrivate 
    ? (roomname.length > 10 ? roomname.substring(0, 8) + '...' : roomname)
    : roomname;
  currentRoomTitle.textContent = isPrivate ? `üîí ${displayName}` : `#${displayName}`;
  
  // Start chat in sidebar layer
  switchLayer('sidebar');
  startChat();
}

// ===== CHAT FUNCTIONALITY =====
function startChat() {
  // Normalize the room name a bit.
  roomname = roomname.replace(/[^a-zA-Z0-9_-]/g, "").replace(/_/g, "-").toLowerCase();

  if (roomname.length > 32 && !roomname.match(/^[0-9a-f]{64}$/)) {
    addChatMessage("ERROR", "Invalid room name.");
    return;
  }

  document.location.hash = "#" + roomname;

  // Setup chat input handlers
  chatInput.addEventListener("keydown", event => {
    if (event.keyCode == 38) { // up arrow
      chatlog.scrollBy(0, -50);
    } else if (event.keyCode == 40) { // down arrow
      chatlog.scrollBy(0, 50);
    } else if (event.keyCode == 33) { // page up
      chatlog.scrollBy(0, -chatlog.clientHeight + 50);
    } else if (event.keyCode == 34) { // page down
      chatlog.scrollBy(0, chatlog.clientHeight - 50);
    }
  });

  chatroom.addEventListener("submit", event => {
    event.preventDefault();

    if (currentWebSocket) {
      currentWebSocket.send(JSON.stringify({message: chatInput.value}));
      chatInput.value = "";

      // Scroll to bottom whenever sending a message.
      chatlog.scrollBy(0, 1e8);
    }
  });

  chatInput.addEventListener("input", event => {
    if (event.currentTarget.value.length > 256) {
      event.currentTarget.value = event.currentTarget.value.slice(0, 256);
    }
  });

  chatlog.addEventListener("scroll", event => {
    isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight;
  });

  // Back button handler
  backToSidebarBtn.addEventListener("click", () => {
    switchLayer('sidebar');
  });

  // Focus chat input when clicking anywhere
  document.body.addEventListener("click", event => {
    if (window.getSelection().toString() == "" && currentLayer === 'chat') {
      chatInput.focus();
    }
  });

  // Detect mobile keyboard
  if('visualViewport' in window) {
    window.visualViewport.addEventListener('resize', function(event) {
      if (isAtBottom) {
        chatlog.scrollBy(0, 1e8);
      }
    });
  }

  // Setup participant observer
  const roster = document.getElementById('roster');
  const participantObserver = new MutationObserver(updateParticipantList);
  participantObserver.observe(roster, { childList: true, subtree: true });
  
  // Initial setup of clickable items
  setupClickableItems();
  
  // Join the room
  join();
}

// ===== WEBSOCKET HANDLING =====
let lastSeenTimestamp = 0;
let wroteWelcomeMessages = false;

function join() {
  // If we are running via wrangler dev, use ws:
  const wss = document.location.protocol === "http:" ? "ws://" : "wss://";
  let ws = new WebSocket(wss + hostname + "/api/room/" + roomname + "/websocket");
  let rejoined = false;
  let startTime = Date.now();

  let rejoin = async () => {
    if (!rejoined) {
      rejoined = true;
      currentWebSocket = null;

      // Clear the roster.
      const participantsContainer = document.getElementById('participants-container');
      participantsContainer.innerHTML = '';

      // Don't try to reconnect too rapidly.
      let timeSinceLastJoin = Date.now() - startTime;
      if (timeSinceLastJoin < 10000) {
        // Less than 10 seconds elapsed since last join. Pause a bit.
        await new Promise(resolve => setTimeout(resolve, 10000 - timeSinceLastJoin));
      }

      // OK, reconnect now!
      join();
    }
  }

  ws.addEventListener("open", event => {
    currentWebSocket = ws;
    // Send user info message.
    ws.send(JSON.stringify({name: username}));
  });

  ws.addEventListener("message", event => {
    let data = JSON.parse(event.data);

    if (data.error) {
      addChatMessage(null, "* Error: " + data.error);
    } else if (data.joined) {
      let p = document.createElement("p");
      p.innerText = data.joined;
      const roster = document.getElementById('roster');
      roster.appendChild(p);
    } else if (data.quit) {
      const roster = document.getElementById('roster');
      for (let child of roster.childNodes) {
        if (child.innerText == data.quit) {
          roster.removeChild(child);
          break;
        }
      }
    } else if (data.ready) {
      // All pre-join messages have been delivered.
      if (!wroteWelcomeMessages) {
        wroteWelcomeMessages = true;
        addChatMessage(null,
            "* This is a demo app built with Cloudflare Workers Durable Objects. The source code " +
            "can be found at: https://github.com/cloudflare/workers-chat-demo");
        addChatMessage(null,
            "* WARNING: Participants in this chat are random people on the internet. " +
            "Names are not authenticated; anyone can pretend to be anyone. The people " +
            "you are chatting with are NOT Cloudflare employees. Chat history is saved.");
        if (roomname.length == 64) {
          addChatMessage(null,
              "* This is a private room. You can invite someone to the room by sending them the URL.");
        } else {
          addChatMessage(null,
              "* Welcome to #" + roomname + ". Say hi!");
        }
      }
    } else {
      // A regular chat message.
      if (data.timestamp > lastSeenTimestamp) {
        addChatMessage(data.name, data.message);
        lastSeenTimestamp = data.timestamp;
      }
    }
  });

  ws.addEventListener("close", event => {
    console.log("WebSocket closed, reconnecting:", event.code, event.reason);
    rejoin();
  });
  ws.addEventListener("error", event => {
    console.log("WebSocket error, reconnecting:", event);
    rejoin();
  });
}

function addChatMessage(name, text) {
  let p = document.createElement("p");
  if (name) {
    let tag = document.createElement("span");
    tag.className = "username";
    tag.innerText = name + ": ";
    p.appendChild(tag);
  }
  p.appendChild(document.createTextNode(text));

  // Append the new chat line
  chatlog.appendChild(p);
  if (isAtBottom) {
    chatlog.scrollBy(0, 1e8);
  }
}

// ===== INITIALIZATION =====
// Start the app
startNameChooser();
</script>
<!--===================================================================================-->
</html>
