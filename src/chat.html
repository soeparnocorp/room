<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
      * { box-sizing: border-box; }
      body { font-family: Arial, Helvetica, sans-serif; margin:0; }

      #top-panel {
        position: fixed; top:0; left:0; right:0; background:white; z-index:3; padding:8px;
      }
      #name-input, #room-name, #go-public, #go-private { font-size: 1em; margin:2px; }

      #search-panel {
        position: fixed; top:5em; left:0; right:0; background:#f9f9f9; z-index:2; padding:8px;
      }
      #search-room { width:70%; }
      #search-button { width:25%; }

      #chatroom {
        position: fixed; top:10em; bottom:0; left:0; right:0; display:flex; flex-direction:column;
      }
      #chatlog {
        flex:1; overflow-y:auto; padding:8px; border-top:1px solid #ccc;
      }
      #chatlog span.username { font-weight:bold; }
      #chat-input { height:32px; width:100%; border:none; border-top:1px solid #ccc; padding-left:8px; }

      #roster { position:fixed; top:10em; right:0; width:200px; bottom:32px; font-weight:bold; overflow:auto; border-left:1px solid #ccc; }
      @media(max-width:600px) { #roster { display:none; } #chatroom { right:0; } }

      button { cursor:pointer; }
    </style>
  </head>
  <body>
    <div id="top-panel">
      <input id="name-input" placeholder="Your Name">
      <input id="room-name" placeholder="Room Name">
      <button id="go-public">Go Public</button>
      <button id="go-private">Private Room</button>
    </div>

    <div id="search-panel">
      <input id="search-room" placeholder="Search Room">
      <button id="search-button">Search</button>
    </div>

    <form id="chatroom" action="/fake-form-action">
      <div id="chatlog"></div>
      <input id="chat-input" autocomplete="off">
    </form>
    <div id="roster"></div>

    <script>
      let currentWebSocket = null;
      let username, roomname;
      const hostname = window.location.host || "room.soeparnocorp.workers.dev";

      const nameInput = document.getElementById("name-input");
      const roomInput = document.getElementById("room-name");
      const goPublic = document.getElementById("go-public");
      const goPrivate = document.getElementById("go-private");
      const chatInput = document.getElementById("chat-input");
      const chatlog = document.getElementById("chatlog");
      const roster = document.getElementById("roster");
      const searchRoom = document.getElementById("search-room");
      const searchButton = document.getElementById("search-button");

      function startChat() {
        document.location.hash = "#" + roomname;
        const wss = location.protocol === "http:" ? "ws://" : "wss://";
        let ws = new WebSocket(wss + hostname + "/api/room/" + roomname + "/websocket");
        currentWebSocket = ws;

        ws.addEventListener("open",()=>{ ws.send(JSON.stringify({name:username})) });
        ws.addEventListener("message", event => {
          let data = JSON.parse(event.data);
          if (data.error) addMessage(null, "* Error: "+data.error);
          else if (data.joined){ let p=document.createElement("p"); p.innerText=data.joined; roster.appendChild(p);}
          else if (data.quit){ for(let c of roster.childNodes){ if(c.innerText==data.quit) roster.removeChild(c);}}
          else if (data.ready) addMessage(null,"* Welcome to #" + roomname);
          else addMessage(data.name, data.message);
        });
        ws.addEventListener("close",()=>setTimeout(()=>startChat(),5000));
        ws.addEventListener("error",()=>setTimeout(()=>startChat(),5000));
      }

      function addMessage(name,text){
        let p=document.createElement("p");
        if(name){ let s=document.createElement("span"); s.className="username"; s.innerText=name+": "; p.appendChild(s);}
        p.appendChild(document.createTextNode(text));
        chatlog.appendChild(p);
        chatlog.scrollTop=chatlog.scrollHeight;
      }

      goPublic.addEventListener("click", async ()=>{
        username = nameInput.value.trim(); roomname = roomInput.value.trim();
        if(!username||!roomname) return;
        startChat();
      });

      goPrivate.addEventListener("click", async ()=>{
        username = nameInput.value.trim();
        if(!username) return;
        let res = await fetch("https://"+hostname+"/api/room",{method:"POST"});
        if(!res.ok) return alert("something went wrong");
        roomname = await res.text(); startChat();
      });

      searchButton.addEventListener("click", ()=>{
        let val = searchRoom.value.trim();
        if(val.length>0){ roomname=val; startChat();}
      });

      chatInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); if(currentWebSocket){ currentWebSocket.send(JSON.stringify({message:chatInput.value})); chatInput.value=""; chatlog.scrollTop=chatlog.scrollHeight;}}});
    </script>
  </body>
</html>
